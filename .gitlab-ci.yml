default:
  image: gitlab-registry.cern.ch/ci-tools/ci-worker:cc7
  tags:
    - k8s-cvmfs
  before_script:
    - ulimit -n 1048576
    - set +e
    - export ATLAS_LOCAL_ROOT_BASE=/cvmfs/atlas.cern.ch/repo/ATLASLocalRootBase
    - source ${ATLAS_LOCAL_ROOT_BASE}/user/atlasLocalSetup.sh --quiet
    - asetup StatAnalysis,0.2,latest

variables:
  GIT_SUBMODULE_STRATEGY: normal

stages:
  - build
  - check
  - run
  - compare_results
  - webpage

cmake:
  stage: build
  script:
     - mkdir -p build && cd build
     - cmake -DCMAKE_INSTALL_PREFIX=../install/ .. | tee cmake.log
  artifacts:
     paths:
      - build
     expire_in: 1d

make_doxygen:
  stage: build
  script:
     - mkdir -p doc_build && cd doc_build
     - cmake -DBUILD_DOC=ON .. | tee cmake.log
     - make doc_doxygen
     - ls
  only:
    - main@atlas-amglab/fastframes
  artifacts:
     paths:
      - doc_build/docs/
     expire_in: 1d

compile:
  stage: build
  needs:
    - cmake
  script:
     - cd build
     - make clean #make sure we don't have residual compilation results
     - make -j4 2>&1 | tee -a make.log  #dump the log files
  artifacts:
     paths:
      - build
     expire_in: 1d

install:
  stage: build
  needs:
    - compile
  script:
     - mkdir -p install
     - cd build
     - make install | tee -a install.log  #dump the log files
  artifacts:
     paths:
      - install
     expire_in: 1d

cppcheck:
  stage: check
  # image is from https://hub.docker.com/r/neszt/cppcheck-docker
  image:
    name: registry.cern.ch/docker.io/neszt/cppcheck-docker:latest
    entrypoint: [""]
  before_script:
    - "" # overwrite default, do nothing
  needs:
    - compile
  script:
    - cppcheck --version
    - echo "running cppcheck"
    - set +e
    - echo $ROOTSYS
    - cppcheck --enable=all --verbose --output-file=cppcheck.txt --inline-suppr --language=c++ --suppress=useStlAlgorithm --project=build/compile_commands.json --suppress=missingIncludeSystem --suppress=unusedFunction --suppress=missingInclude --suppress=*:build/* --suppress=*:/cvmfs/* --check-level=exhaustive
    - cat cppcheck.txt
    - source test/scripts/cppcheck_output.sh
  allow_failure: true
  artifacts:
    paths:
      - cppcheck.txt
    expire_in: 1d
    when: always

python_config_reader_test:
  stage: run
  needs:
    - compile
  script:
     - cd python/ConfigReaderModules/
     - python3 ConfigReader.py ../../test/configs/config.yml

run_filelist:
  stage: run
  needs:
     - cmake
  script:
     - python3 python/produce_metadata_files.py --root_files_folder test/input/
  artifacts:
     paths:
      - test/input/
     expire_in: 1d

run_cpp:
  stage: run
  needs:
    - compile
    - run_filelist
  script:
     - ./build/bin/fast-frames.exe
  artifacts:
     paths:
      - ttbar_FS.root
     expire_in: 1d

run_python:
  stage: run
  needs:
    - compile
    - run_filelist
  script:
     - python3 python/FastFrames.py test/configs/config.yml
  artifacts:
     paths:
      - ttbar_FS.root
     expire_in: 1d

config_reader_comparison:
  stage: compare_results
  needs:
    - compile
  script:
     - python3 python/ConfigReaderModules/ConfigReader.py test/reference_files/config_reading/config_testing.yml > log.txt
     - python3 test/python/compare_two_files.py log.txt test/reference_files/config_reading/reference_log.txt
  allow_failure: true

doxygen_webpage:
  stage: webpage
  needs:
    - make_doxygen
  before_script:
    - date
    - echo "${EOS_ACCOUNT_PASSWORD}" | kinit ${EOS_ACCOUNT_USERNAME}@CERN.CH
    - klist
    - cp docs/custom_krb5.conf /etc/krb5.conf
    - cp docs/custom_ssh.conf /etc/ssh/ssh_config
    - mkdir ~/.ssh
    - ls ~/.ssh
    - echo -e "Host lxplus.cern.ch\n\tUser ${EOS_ACCOUNT_USERNAME}\n\tStrictHostKeyChecking no\n\tGSSAPIAuthentication yes\n\tGSSAPIDelegateCredentials yes\n\tProtocol 2\n\tForwardX11 no\n\tIdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
    - cat ~/.ssh/config
    - date
  script:
    - ls doc_build/
    - ls doc_build/docs
    - ls doc_build/docs/html
    - tar cvzf - -C doc_build/docs/html/ . | ssh ${EOS_ACCOUNT_USERNAME}@lxplus.cern.ch tar xzf - -C /eos/user/t/topreco/www/fastframesdocumentation
  only:
    - main@atlas-amglab/fastframes
